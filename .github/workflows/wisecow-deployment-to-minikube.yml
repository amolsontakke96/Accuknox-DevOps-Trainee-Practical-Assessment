name: Build and Deploy to Minikube

on:
  push:
    branches:
      - main  # Change this to your default branch if it's different

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4
      with:
          repository: amolsontakke96/Accuknox-DevOps-Trainee-Practical-Assessment
    
    - name: Set up Minikube
      uses: medyagh/setup-minikube@master
      
    - name: Minikube setup
      run: |
        echo "YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eTogTUlJREJqQ0NBZTZnQXdJQkFnSUJBVEFOQmdrcWhraUc5dzBCQVFzRkFEQVZNUk13RVFZRFZRUURFd3B0YVc1cGEzVmlaVU5CTUI0WERUSTBNRFl4TnpBMU1URTBObG9YRFRNME1EWXhOakExTVRFME5sb3dGVEVUTUJFR0ExVUVBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBSmtDTndiV1IreHNwRnpjVHBLNGUyNVlOS0UxcmtKaXJEZE5pY1krNy9pSFVMMHRIcngxSU1xcWVjRG9YcU9RR2pHejB5UmcrdXp3Z2ZoL3d4Q1NpZWdzL1ViT0dGN0Qrb1NZejBTcnlSWjQ0MWJzcnBQazJ3ZnVUTVlWRlJYZFhwblBoQW1SQ3M0QzBGK3c4QVRqMlNKelpGaVZLRTlBUGtOZktMUkd4SWsrMWVmMXpGUXNDMTJCZW5BbnRSbUh4YUg4WVpjTEN5SExubGpDMDFxUUdRYUZrYWVkRDNSeThKZzhabU9PRnN5cndXUnMyaUdTM2JzK2Fxb1NTSlIwNldRUjVoVXA0aWtCZ0IzNCtUZHN3ODNzOXJoWG5mY2VLVnN0SldWRW45RzJCYTZrNTlXZHYzY0hoNkR6TVZ4TGl6VFk1bVdIWWRpKzliL2ZOanZoNFk4Q0F3RUFBYU5oTUY4d0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXTUJRR0NDc0dBUVVGQndNQ0JnZ3JCZ0VGQlFjREFUQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01CMEdBMVVkRGdRV0JCVHlrN0FLV2pzVFIvbGJGRUo2MDUwR3A3bWFYREFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBTXJ0VjdYdmgxYUZoZEwyU1k3NWt4OFVhdDAzQUcra2crS1o5QkJIVjJnNmdtcEhkdzFOVm9ac3E0VWY1SURLT2pRcUFFN0hya1ZZbnpaSTE2VlMrMVRoTFVkRkJ1K3NQa042RTF4SHN1UC9RVEdwZmNsSThRb0FTYmJZa0J2NURDMzg1Tk9VTjVhSUppSlJtblg1QkNidGlqUGhCYU1WaGcwa2pHaXlnV1pqbThITVNlSGFXWElHRnpTRUVmdHJ6U0V2QlJkVUkzYTJDWWJjQk1rUVY2NVNxQThGakVPdHZVS29PNG1ZRmw3NloxRFljbElXZmlYVWxTU044ZitOYjZNUWFCNER2NzJRWjgvQzVjNU8zeWtrQTVKRG8wMyt4SXFhTHNZK3BNcGpUTEhzQVdJMmdBclM4ODQwQWl3N2NTNXNnSFNmbG1qSW9YQ01BV0ptRkRBPT0KICAgIGV4dGVuc2lvbnM6CiAgICAtIGV4dGVuc2lvbjoKICAgICAgICBsYXN0LXVwZGF0ZTogTW9uLCAyMiBKdWwgMjAyNCAxMDo0NzozNiBJU1QKICAgICAgICBwcm92aWRlcjogbWluaWt1YmUuc2lncy5rOHMuaW8KICAgICAgICB2ZXJzaW9uOiB2MS4zMy4xCiAgICAgIG5hbWU6IGNsdXN0ZXJfaW5mbwogICAgc2VydmVyOiBodHRwczovLzE5Mi4xNjguNDkuMjo4NDQzCiAgbmFtZTogbWluaWt1YmUKY29udGV4dHM6Ci0gY29udGV4dDoKICAgIGNsdXN0ZXI6IG1pbmlrdWJlCiAgICBleHRlbnNpb25zOgogICAgLSBleHRlbnNpb246CiAgICAgICAgbGFzdC11cGRhdGU6IE1vbiwgMjIgSnVsIDIwMjQgMTA6NDc6MzYgSVNUCiAgICAgICAgcHJvdmlkZXI6IG1pbmlrdWJlLnNpZ3MuazhzLmlvCiAgICAgICAgdmVyc2lvbjogdjEuMzMuMQogICAgICBuYW1lOiBjb250ZXh0X2luZm8KICAgIG5hbWVzcGFjZTogZGVmYXVsdAogICAgdXNlcjogbWluaWt1YmUKICBuYW1lOiBtaW5pa3ViZQpjdXJyZW50LWNvbnRleHQ6IG1pbmlrdWJlCmtpbmQ6IENvbmZpZwpwcmVmZXJlbmNlczoge30KdXNlcnM6Ci0gbmFtZTogbWluaWt1YmUKICB1c2VyOgogICAgY2xpZW50LWNlcnRpZmljYXRlOiAvcm9vdC8ubWluaWt1YmUvcHJvZmlsZXMvbWluaWt1YmUvY2xpZW50LmNydAogICAgY2xpZW50LWtleTogL3Jvb3QvLm1pbmlrdWJlL3Byb2ZpbGVzL21pbmlrdWJlL2NsaWVudC5rZXkK#" | base64 -d > ${HOME}/.kube/config
        cat ${HOME}/.kube/config
      shell: bash
        
    - name: Start Minikube
      run: |
        minikube start --driver=docker
        eval $(minikube -p minikube docker-env)
        minikube status
        kubectl get nodes
        minikube kubectl -- get pods
        kubectl apply -f wisecow.yaml
        kubectl wait --for=condition=ready pod -l app=wisecow
        kubectl get pods -A
